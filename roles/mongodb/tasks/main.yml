---
# tasks file for mongodb role

- name: MongoDB | Add MongoDB GPG key
  ansible.builtin.get_url:
    url: "https://www.mongodb.org/static/pgp/server-{{ mongodb_version }}.asc"
    dest: /etc/apt/trusted.gpg.d/mongodb-org-{{ mongodb_version }}.asc
    mode: '0644'
    force: yes
  become: yes

- name: MongoDB | Add MongoDB repository
  ansible.builtin.apt_repository:
    repo: "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu {{ ansible_distribution_release }}/mongodb-org/{{ mongodb_version }} multiverse"
    state: present
    filename: mongodb-org-{{ mongodb_version }}
  become: yes

- name: MongoDB | Install MongoDB package
  ansible.builtin.apt:
    name: "mongodb-org={{ mongodb_package_version }}"
    state: present
    update_cache: yes
  become: yes

# --- NEUER ABSCHNITT ---
- name: MongoDB | Configure MongoDB for Graylog
  ansible.builtin.template:
    src: mongod.conf.j2
    dest: /etc/mongod.conf
    owner: root
    group: root
    mode: '0644'
  become: yes
  notify: Restart mongod # Benachrichtigt den Handler, den Dienst neu zu starten

# Sicherstellen, dass der Dienst läuft, bevor wir das Replica Set initialisieren
- name: MongoDB | Ensure mongod service is started and enabled
  ansible.builtin.systemd:
    name: mongod
    state: started
    enabled: yes
    daemon_reload: yes
  become: yes

- name: MongoDB | Initialize the replica set
  community.mongodb.mongodb_replicaset:
    login_host: "localhost"
    login_port: 27017
    replica_set: "{{ mongodb_repl_set_name }}"
    members:
      - "{{ ansible_default_ipv4.address }}:27017"
  become: yes
  run_once: true # Dieser Task soll nur einmal ausgeführt werden, auch wenn mehrere Mongo-Server im Play wären
# --- ENDE NEUER ABSCHNI
TT ---
